# Start from a base image, e.g., Ubuntu
FROM --platform=linux/amd64 ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        gnupg \
        wget \
        openjdk-17-jdk \
        maven && \
    rm -rf /var/lib/apt/lists/*

# Install Go 1.23 (latest stable, meets 1.22+ requirement)
RUN curl -fsSL https://go.dev/dl/go1.23.4.linux-amd64.tar.gz -o go.tar.gz && \
    tar -C /usr/local -xzf go.tar.gz && \
    rm go.tar.gz 

# Add official k6 apt repository and install k6 load testing CLI.
RUN mkdir -p /usr/share/keyrings && \
    curl -fsSL https://dl.k6.io/key.gpg | gpg --dearmor --yes -o /usr/share/keyrings/k6-archive-keyring.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" > /etc/apt/sources.list.d/k6.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends k6 && \
    rm -rf /var/lib/apt/lists/*     

# Install Grafana Alloy from the official Grafana apt repository.
RUN mkdir -p /etc/apt/keyrings/ && \
    wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor --yes -o /etc/apt/keyrings/grafana.gpg && \
    echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" > /etc/apt/sources.list.d/grafana.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends alloy && \
    rm -rf /var/lib/apt/lists/* 

ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
ENV GOROOT=/usr/local/go
ENV PATH=$PATH:$GOROOT/bin:$JAVA_HOME/bin 